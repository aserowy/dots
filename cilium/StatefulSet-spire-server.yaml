apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: spire-server
  name: spire-server
  namespace: cilium-spire
spec:
  replicas: 1
  selector:
    matchLabels:
      app: spire-server
  serviceName: spire-server
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/default-container: spire-server
      labels:
        app: spire-server
    spec:
      containers:
        - command:
            - /bin/sh
            - -c
            - |
              # shellcheck disable=SC2086
              # shellcheck disable=SC2139
              set -e

              echo "Waiting for spire process to start"
              while ! pgrep spire-server > /dev/null; do sleep 5; done

              SPIRE_SERVER_ROOT_PATH="/proc/$(pgrep spire-server)/root"

              alias spire_server="${SPIRE_SERVER_ROOT_PATH}/opt/spire/bin/spire-server"
              SOCKET_PATH="${SPIRE_SERVER_ROOT_PATH}/tmp/spire-server/private/api.sock"
              SOCKET_FLAG="-socketPath ${SOCKET_PATH}"

              echo "Checking spire-server status"
              while ! spire_server entry show ${SOCKET_FLAG} &> /dev/null; do
                echo "Waiting for spire-server to start..."
                sleep 5
              done

              echo "Spire Server is up, initializing cilium spire entries..."

              AGENT_SPIFFE_ID="spiffe://spiffe.cilium/ns/cilium-spire/sa/spire-agent"
              AGENT_SELECTORS="-selector k8s_psat:agent_ns:cilium-spire -selector k8s_psat:agent_sa:spire-agent"
              CILIUM_AGENT_SPIFFE_ID="spiffe://spiffe.cilium/cilium-agent"
              CILIUM_AGENT_SELECTORS="-selector k8s:ns:kube-system -selector k8s:sa:cilium"
              CILIUM_OPERATOR_SPIFFE_ID="spiffe://spiffe.cilium/cilium-operator"
              CILIUM_OPERATOR_SELECTORS="-selector k8s:ns:kube-system -selector k8s:sa:cilium-operator"

              while pgrep spire-server > /dev/null;
              do
                echo "Ensuring agent entry"
                if spire_server entry show ${SOCKET_FLAG} -spiffeID $AGENT_SPIFFE_ID $AGENT_SELECTORS | grep -q "Found 0 entries" &> /dev/null; then
                  spire_server entry create ${SOCKET_FLAG} -spiffeID $AGENT_SPIFFE_ID $AGENT_SELECTORS -node
                fi

                echo "Ensuring cilium-agent entry (required for the delegated identity to work)"
                if spire_server entry show ${SOCKET_FLAG} -spiffeID $CILIUM_AGENT_SPIFFE_ID $CILIUM_AGENT_SELECTORS | grep -q "Found 0 entries" &> /dev/null; then
                  spire_server entry create ${SOCKET_FLAG} -spiffeID $CILIUM_AGENT_SPIFFE_ID -parentID $AGENT_SPIFFE_ID $CILIUM_AGENT_SELECTORS
                fi

                echo "Ensuring cilium-operator entry (required for creating SPIFFE identities)"
                if spire_server entry show ${SOCKET_FLAG} -spiffeID $CILIUM_OPERATOR_SPIFFE_ID $CILIUM_OPERATOR_SELECTORS | grep -q "Found 0 entries" &> /dev/null; then
                  spire_server entry create ${SOCKET_FLAG} -spiffeID $CILIUM_OPERATOR_SPIFFE_ID -parentID $AGENT_SPIFFE_ID $CILIUM_OPERATOR_SELECTORS
                fi

                echo "Cilium Spire entries are initialized successfully or already in-sync"
                sleep 30;
              done
          image: docker.io/library/busybox:1.37.0@sha256:2383baad1860bbe9d8a7a843775048fd07d8afe292b94bd876df64a69aae7cb1
          imagePullPolicy: IfNotPresent
          name: cilium-init
        - args:
            - -config
            - /run/spire/config/server.conf
          image: ghcr.io/spiffe/spire-server:1.12.4@sha256:34147f27066ab2be5cc10ca1d4bfd361144196467155d46c45f3519f41596e49
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 2
            httpGet:
              path: /live
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 60
            timeoutSeconds: 3
          name: spire-server
          ports:
            - containerPort: 8081
              name: grpc
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
          volumeMounts:
            - mountPath: /run/spire/config
              name: spire-config
              readOnly: true
            - mountPath: /run/spire/data
              name: spire-data
              readOnly: false
            - mountPath: /tmp/spire-server/private
              name: spire-server-socket
              readOnly: false
      priorityClassName: system-node-critical
      serviceAccountName: spire-server
      shareProcessNamespace: true
      volumes:
        - configMap:
            name: spire-server
          name: spire-config
        - hostPath:
            path: /var/run/spire-server/sockets
            type: DirectoryOrCreate
          name: spire-server-socket
  volumeClaimTemplates:
    - metadata:
        name: spire-data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
        storageClassName: longhorn-nobackup
