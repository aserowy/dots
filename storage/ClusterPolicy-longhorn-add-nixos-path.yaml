apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  annotations:
    policies.kyverno.io/category: Other
    policies.kyverno.io/description: Longhorn invokes executables on the host system, and needs to be aware of the host systems PATH. This modifies all deployments such that the PATH is explicitly set to support NixOS based systems.
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/title: Add Environment Variables from ConfigMap
  name: longhorn-add-nixos-path
spec:
  rules:
    - match:
        resources:
          kinds:
            - Pod
          namespaces:
            - longhorn-system
      mutate:
        patchStrategicMerge:
          spec:
            containers:
              - (name): '*'
                envFrom:
                  - configMapRef:
                      name: longhorn-nixos-path
            initContainers:
              - (name): '*'
                envFrom:
                  - configMapRef:
                      name: longhorn-nixos-path
      name: add-env-vars
